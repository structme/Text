WITH cte AS (
    SELECT 
        log_id,
        kayıtdurum,
        logtarih,
        LEAD(kayıtdurum) OVER (PARTITION BY log_id ORDER BY logtarih) AS sonraki_kayıtdurum,
        LEAD(logtarih) OVER (PARTITION BY log_id ORDER BY logtarih) AS sonraki_logtarih
    FROM 
        log_tablosu
),
cte_last AS (
    SELECT 
        log_id,
        kayıtdurum,
        logtarih,
        sonraki_kayıtdurum,
        sonraki_logtarih,
        ROW_NUMBER() OVER (PARTITION BY log_id ORDER BY logtarih DESC) AS rn
    FROM 
        cte
    WHERE 
        kayıtdurum = 4
)
SELECT 
    log_id,
    kayıtdurum,
    sonraki_kayıtdurum,
    CASE 
        WHEN sonraki_kayıtdurum IS NULL THEN ROUND((SYSDATE - logtarih) * 24 * 60 * 60) -- Son kayıt 4 ise SYSDATE'ten çıkar
        ELSE ROUND((sonraki_logtarih - logtarih) * 24 * 60 * 60) -- Sonraki kayıtdurum varsa farkı al
    END AS sure_saniye
FROM 
    cte_last
WHERE 
    rn = 1;
